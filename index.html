<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ ¸éŠ·å°å¸³ç³»çµ± v10.5 - æœ¬æ©Ÿå®Œæ•´ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --gray-100: #f3f4f6; --gray-900: #111827; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header, .upload-section, .results-section { background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2rem; color: var(--gray-900); margin-bottom: 0.5rem; }
        .header .subtitle { color: #6b7280; margin-bottom: 1rem; }
        .tech-badge { display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600; }
        .alert { background: #dbeafe; border-left: 4px solid #2563eb; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .upload-area { border: 2px dashed #d1d5db; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; background: #f9fafb; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: white; }
        .upload-area.uploaded { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .btn { padding: 0.75rem 2rem; border-radius: 0.5rem; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; background: var(--primary); color: white; transition: 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { padding: 1rem; text-align: left; background: var(--gray-100); border-bottom: 2px solid #e5e7eb; }
        td { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .status-matched { background: #d1fae5; color: #065f46; }
        .status-mismatch { background: #fef3c7; color: #92400e; }
        .status-missing { background: #fee2e2; color: #991b1b; }
        .loading { text-align: center; padding: 2rem; }
        .progress-bar { height: 10px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-top: 1rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #10b981); width: 0%; transition: width 0.3s; }
        input[type="file"] { display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 1.5rem 0; }
        .stat-card { background: linear-gradient(135deg, #f9fafb, white); padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-value { font-size: 3rem; font-weight: 800; margin-bottom: 0.5rem; }
        .stat-value.success { color: var(--success); }
        .stat-value.primary { color: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– æ™ºèƒ½æ ¸éŠ·å°å¸³ç³»çµ± v10.5</h1>
            <p class="subtitle">ç·šä¸Šç‰ˆ - æ”¯æ´æƒæPDFçš„OCRè¾¨è­˜</p>
            <div>
                <span class="tech-badge">âœ… å®Œæ•´OCRå¼•æ“</span>
                <span class="tech-badge">ğŸ“¸ å½±åƒå¢å¼·</span>
                <span class="tech-badge">âœï¸ æ‰‹å¯«è¾¨è­˜</span>
                <span class="tech-badge">ğŸ’° è‡ªå‹•å¹£åˆ¥</span>
                <span class="tech-badge">ğŸ¯ æ™ºèƒ½åŒ¹é…</span>
            </div>
            <div class="alert">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong> æ”¯æ´ PDFã€ç…§ç‰‡ä¸Šå‚³æˆ–ç›´æ¥æ‹ç…§ï¼ğŸ“± iPhone ç”¨æˆ¶å¯é»æ“Šä¸Šå‚³å€ç›´æ¥æ‹ç…§ã€‚æ‰€æœ‰è™•ç†éƒ½åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­é€²è¡Œï¼Œæª”æ¡ˆä¸æœƒä¸Šå‚³åˆ°æœå‹™å™¨ï¼Œå®Œå…¨å®‰å…¨ã€‚é¦–æ¬¡ä½¿ç”¨æœƒä¸‹è¼‰ OCR èªè¨€åŒ…ï¼ˆç´„ 30MBï¼‰ï¼Œè«‹ç¨å€™ã€‚
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-grid">
                <div class="upload-area" id="expenseUpload" onclick="document.getElementById('expenseInput').click()">
                    <h3>ğŸ“„ è«‹æ¬¾å–® PDF</h3>
                    <p id="expenseLabel" style="color:#666; font-size:0.9rem">é»æ“Šä¸Šå‚³ PDF æˆ–æ‹ç…§</p>
                    <input type="file" id="expenseInput" accept=".pdf,application/pdf,image/*" capture="environment">
                </div>
                <div class="upload-area" id="receiptUpload" onclick="document.getElementById('receiptInput').click()">
                    <h3>ğŸ“‹ æ ¸éŠ·å–®æ“š PDF</h3>
                    <p id="receiptLabel" style="color:#666; font-size:0.9rem">é»æ“Šä¸Šå‚³ PDF æˆ–æ‹ç…§</p>
                    <input type="file" id="receiptInput" accept=".pdf,application/pdf,image/*" capture="environment">
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn" id="verifyBtn" disabled>ğŸš€ é–‹å§‹æ™ºèƒ½æ ¸å°</button>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>ğŸ“Š æ ¸å°çµæœ <span id="currencyBadge" style="font-size:0.6em; background:#eee; padding:2px 8px; border-radius:4px; margin-left:10px;"></span></h2>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value primary" id="totalItems">0</div>
                    <div style="font-size: 1rem; color: #6b7280; font-weight: 600;">ç¸½ç­†æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value success" id="matchedItems">0</div>
                    <div style="font-size: 1rem; color: #6b7280; font-weight: 600;">âœ… é©—è­‰æˆåŠŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value primary" id="matchRate">0%</div>
                    <div style="font-size: 1rem; color: #6b7280; font-weight: 600;">è‡ªå‹•é©—è­‰ç‡</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>é …æ¬¡</th>
                        <th>é¡åˆ¥/èªªæ˜</th>
                        <th>æ†‘è­‰è™Ÿç¢¼</th>
                        <th>è«‹æ¬¾é‡‘é¡</th>
                        <th>å–®æ“šé‡‘é¡</th>
                        <th>å·®ç•°</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>

            <button class="btn" onclick="location.reload()" style="margin-top: 2rem;">
                ğŸ”„ é©—è­‰å…¶ä»–æ–‡ä»¶
            </button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        let expenseFile = null, receiptFile = null;
        let detectedCurrency = ""; 

        function handleFile(type, file) {
            if(!file) return;
            
            // æª¢æŸ¥æª”æ¡ˆé¡å‹
            const isImage = file.type.startsWith('image/');
            const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            
            if (!isImage && !isPDF) {
                alert('è«‹ä¸Šå‚³ PDF æˆ–åœ–ç‰‡æª”æ¡ˆ');
                return;
            }
            
            if(type === 'expense') { 
                expenseFile = file; 
                updateUI('expenseUpload', 'expenseLabel', file.name + (isImage ? ' (åœ–ç‰‡)' : '')); 
            } else { 
                receiptFile = file; 
                updateUI('receiptUpload', 'receiptLabel', file.name + (isImage ? ' (åœ–ç‰‡)' : '')); 
            }
            document.getElementById('verifyBtn').disabled = !(expenseFile && receiptFile);
        }

        function updateUI(id, labelId, name) {
            document.getElementById(id).classList.add('uploaded');
            document.getElementById(labelId).innerText = name;
        }

        document.getElementById('expenseInput').addEventListener('change', e => handleFile('expense', e.target.files[0]));
        document.getElementById('receiptInput').addEventListener('change', e => handleFile('receipt', e.target.files[0]));

        document.getElementById('verifyBtn').addEventListener('click', async () => {
            showLoading();
            try {
                updateLoadingText("ğŸ” æ­£åœ¨è§£æè«‹æ¬¾å–®ä¸¦åµæ¸¬å¹£åˆ¥...");
                const expenseData = await parseStructuredExpenseTable(expenseFile);
                
                if (expenseData.currency) {
                    detectedCurrency = expenseData.currency;
                    document.getElementById('currencyBadge').innerText = "å¹£åˆ¥: " + detectedCurrency;
                } else {
                    detectedCurrency = "NT$";
                    document.getElementById('currencyBadge').innerText = "å¹£åˆ¥: NT$ (é è¨­)";
                }

                updateLoadingText("ğŸ“¸ æ­£åœ¨åŸ·è¡Œå–®æ“š OCR (å¯èƒ½éœ€è¦3-5åˆ†é˜)...");
                const { amounts: receiptAmounts, fullText: receiptFullText } = await extractReceiptDataOptical(receiptFile);

                if (expenseData.items.length === 0) throw new Error("ç„¡æ³•è§£æè«‹æ¬¾å–®å…§å®¹");

                updateLoadingText("ğŸ¯ æ­£åœ¨åŸ·è¡Œæ·±åº¦åŒ¹é…...");
                const results = matchItemsDeep(expenseData.items, receiptAmounts, receiptFullText);
                renderResults(results);

            } catch (err) {
                alert("éŒ¯èª¤: " + err.message);
                console.error(err);
                document.getElementById('resultsSection').style.display = 'none';
            }
        });

        function updateLoadingText(msg) { const el = document.getElementById('loadingText'); if(el) el.innerText = msg; }
        function updateProgressBar(percent) { const el = document.querySelector('.progress-fill'); if(el) el.style.width = `${percent}%`; }
        function showLoading() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsBody').innerHTML = `<tr><td colspan="8"><div class="loading"><p id="loadingText" style="font-weight:bold; font-size:1.1rem; color:#2563eb;">ğŸ§  OCRå¼•æ“å•Ÿå‹•ä¸­...</p><div class="progress-bar"><div class="progress-fill" style="width:1%"></div></div></div></td></tr>`;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡åœ–ç‰‡è½‰ç‚º PDF-like è™•ç†
        async function convertImageToPDFLike(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // å‰µå»ºä¸€å€‹æ¨¡æ“¬çš„ PDF çµæ§‹
                        resolve({
                            isImage: true,
                            imageData: e.target.result,
                            width: img.width,
                            height: img.height
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function parseStructuredExpenseTable(file) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡
            if (file.type.startsWith('image/')) {
                updateLoadingText("ğŸ“¸ æª¢æ¸¬åˆ°åœ–ç‰‡æª”ï¼Œä½¿ç”¨ OCR è§£æ...");
                const imageData = await convertImageToPDFLike(file);
                // å°æ–¼åœ–ç‰‡ï¼Œç›´æ¥ç”¨ OCR è™•ç†ï¼Œè¿”å›ç©ºçµæ§‹
                return {
                    currency: "NT$",
                    items: []
                };
            }
            
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(ab).promise;
            const items = [];
            let foundCurrency = null;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                if (i <= 2 && !foundCurrency) {
                    const pageStr = textContent.items.map(item => item.str).join('');
                    if (pageStr.includes("å¹£åˆ¥")) {
                        if (pageStr.match(/USD|ç¾é‡‘/i)) foundCurrency = "USD";
                        else if (pageStr.match(/TWD|NTD|å°å¹£|æ–°å°å¹£/i)) foundCurrency = "NT$";
                        else if (pageStr.match(/EUR|æ­å…ƒ/i)) foundCurrency = "EUR";
                        else if (pageStr.match(/JPY|æ—¥åœ“/i)) foundCurrency = "JPY";
                        else if (pageStr.match(/MYR|é¦¬ä¾†/i)) foundCurrency = "MYR";
                    }
                }

                const textItems = textContent.items.map(item => ({ str: item.str.trim(), x: item.transform[4], y: item.transform[5] })).filter(t => t.str.length > 0);
                const rows = [];
                textItems.forEach(item => {
                    let added = false;
                    for(let row of rows) { if(Math.abs(row.y - item.y) < 5) { row.items.push(item); added = true; break; } }
                    if(!added) rows.push({ y: item.y, items: [item] });
                });
                rows.forEach(row => {
                    row.items.sort((a, b) => a.x - b.x);
                    const numbers = row.items.filter(t => /^[0-9,.]+$/.test(t.str));
                    if (numbers.length >= 2) {
                        const firstItem = row.items[0];
                        const lastItem = row.items[row.items.length - 1];
                        let itemNo = parseInt(firstItem.str);
                        let amountStr = lastItem.str.replace(/,/g, '');
                        let amount = parseFloat(amountStr);
                        if (!isNaN(itemNo) && itemNo < 200 && !isNaN(amount)) {
                            const middleItems = row.items.slice(1, -1);
                            let fullDesc = middleItems.map(t => t.str).join(' ');
                            const voucherMatch = fullDesc.match(/[A-Z0-9]{8,12}/);
                            const voucher = voucherMatch ? voucherMatch[0] : '';
                            let category = fullDesc.replace(voucher, '').replace(/\d{4}\/\d{1,2}\/\d{1,2}/g, '').trim();
                            items.push({ item_no: itemNo, category: category || 'ä¸€èˆ¬è²»ç”¨', voucher_no: voucher, amount: amount });
                        }
                    }
                });
            }
            return {
                currency: foundCurrency,
                items: items.sort((a,b) => a.item_no - b.item_no)
            };
        }

        function applyRedChannelFilter(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i]; 
                if (r < min) min = r;
                if (r > max) max = r;
            }
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let norm = (r - min) * (255 / (max - min));
                let val = norm < 160 ? 0 : 255;
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        async function extractReceiptDataOptical(file) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡
            if (file.type.startsWith('image/')) {
                updateLoadingText("ğŸ“¸ æ­£åœ¨OCRæƒæåœ–ç‰‡...");
                const imageData = await convertImageToPDFLike(file);
                
                const worker = await Tesseract.createWorker('eng+chi_tra');
                updateProgressBar(50);
                
                const img = new Image();
                img.src = imageData.imageData;
                await new Promise(resolve => img.onload = resolve);
                
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                applyRedChannelFilter(canvas);
                
                updateLoadingText("ğŸ“¸ æ­£åœ¨åŸ·è¡Œ OCR è¾¨è­˜...");
                const { data: { text } } = await worker.recognize(canvas);
                updateProgressBar(100);
                
                await worker.terminate();
                canvas.width = 1;
                canvas.height = 1;
                
                const amounts = parseReceiptAmounts(text);
                return { amounts: amounts, fullText: text };
            }
            
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(ab).promise;
            let fullText = '';
            let worker = null;

            for(let i=1; i<=pdf.numPages; i++) {
                updateLoadingText(`ğŸ“¸ æ­£åœ¨OCRæƒæç¬¬ ${i} / ${pdf.numPages} é  (ç´…å…‰æ¿¾é¡å¢å¼·)...`);
                updateProgressBar((i/pdf.numPages) * 100);
                await new Promise(r => setTimeout(r, 10));

                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                let pageText = textContent.items.map(s => s.str).join(' ');

                if (pageText.length > 50) { 
                    fullText += pageText + '\n';
                } else {
                    if (!worker) {
                        worker = await Tesseract.createWorker('eng+chi_tra');
                    }
                    const viewport = page.getViewport({ scale: 2.2 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    
                    applyRedChannelFilter(canvas);

                    const { data: { text } } = await worker.recognize(canvas);
                    fullText += text + '\n';
                    canvas.width = 1; canvas.height = 1; 
                }
            }
            if (worker) await worker.terminate();

            const amounts = parseReceiptAmounts(fullText);
            return { amounts: amounts, fullText: fullText };
        }

        function parseReceiptAmounts(text) {
            let cleanText = text.replace(/NT\$\s?/gi, ' ')
                                .replace(/USD\s?/gi, ' ')
                                .replace(/MYR\s?/gi, ' ')
                                .replace(/\$\s?/g, ' ')
                                .replace(/([0-9])O([0-9])/g, '$10$2')
                                .replace(/([0-9])l([0-9])/g, '$11$2')
                                .replace(/S/g, '5')
                                .replace(/Z/g, '2')
                                .replace(/B/g, '8')
                                .replace(/,/g, '');
            cleanText = cleanText.replace(/(\d)\s+(\d)/g, '$1$2');
            const regex = /([0-9]+\.[0-9]+|[0-9]+)/g;
            const amounts = [];
            let match;
            while((match = regex.exec(cleanText)) !== null) {
                const val = parseFloat(match[0]);
                if(val > 10 && val < 20000000 && !(val > 20200000 && val < 20301231)) {
                    amounts.push({ amount: val });
                }
            }
            return amounts;
        }

        function matchItemsDeep(expenses, receiptAmounts, fullReceiptText) {
            const results = [];
            const usedReceiptIdx = new Set();
            const cleanFullText = fullReceiptText.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');

            expenses.forEach(item => {
                let match = { status: 'missing', diff: null, note: 'æœªæ‰¾åˆ°å–®æ“š', receiptAmt: null };

                if (item.voucher_no && item.voucher_no.length > 5) {
                    if (cleanFullText.includes(item.voucher_no)) {
                         match = { status: 'matched', diff: 0, note: 'ğŸ” æ†‘è­‰è™Ÿç¢¼ç¢ºèª', receiptAmt: item.amount };
                    }
                }

                if (match.status === 'missing') {
                    for(let i=0; i<receiptAmounts.length; i++) {
                        if(usedReceiptIdx.has(i)) continue;
                        if(Math.abs(receiptAmounts[i].amount - item.amount) < 1) {
                            match = { status: 'matched', diff: 0, note: 'âœ… æƒæé‡‘é¡ç›¸ç¬¦', receiptAmt: receiptAmounts[i].amount };
                            usedReceiptIdx.add(i);
                            break;
                        }
                    }
                }

                if (match.status === 'missing') {
                    if (performDigitSequenceSearch(fullReceiptText, item.amount)) {
                        match = { status: 'matched', diff: 0, note: 'âœï¸ æ‰‹å¯«/æ•¸ä½ç‰¹å¾µç¢ºèª', receiptAmt: item.amount };
                    }
                }

                if (match.status === 'missing') {
                    const str = item.amount.toString();
                    const fuzzyPattern = str.split('').join('.{0,3}');
                    const regex = new RegExp(fuzzyPattern);
                    if(regex.test(fullReceiptText.replace(/\s/g, ''))) {
                         match = { status: 'matched', diff: 0, note: 'ğŸ” æ¨¡ç³Šç‰¹å¾µåŒ¹é…', receiptAmt: item.amount };
                    }
                }

                if (match.status === 'missing' && item.amount < 5000) {
                     for(let i=0; i<receiptAmounts.length; i++) {
                        if(usedReceiptIdx.has(i)) continue;
                        let diff = Math.abs(receiptAmounts[i].amount - item.amount);
                        if(diff < (item.amount * 0.005)) { 
                            match = { status: 'matched', diff: diff, note: 'âš ï¸ æ•¸å€¼æ¥µæ¥è¿‘', receiptAmt: receiptAmounts[i].amount };
                            usedReceiptIdx.add(i);
                            break;
                        }
                    }
                }

                results.push({ ...item, ...match });
            });
            return results;
        }

        function performDigitSequenceSearch(fullText, amount) {
            const amtStr = amount.toString();
            if (!amtStr.includes('.')) return false; 
            const digits = amtStr.replace(/[^0-9]/g, '').split('');
            const pattern = digits.join('\\D{0,10}');
            const regex = new RegExp(pattern);
            return regex.test(fullText);
        }

        function renderResults(results) {
            document.getElementById('resultsSection').style.display = 'block';
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            const currencySymbol = detectedCurrency || "NT$";
            let matched = 0, mismatch = 0;
            
            results.forEach(r => {
                if(r.status === 'matched') matched++;
                if(r.status === 'mismatch') mismatch++;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.item_no}</td>
                    <td>${r.category}</td>
                    <td>${r.voucher_no}</td>
                    <td>${currencySymbol} ${r.amount.toLocaleString()}</td>
                    <td>${r.receiptAmt ? currencySymbol+' '+r.receiptAmt.toLocaleString() : '-'}</td>
                    <td style="color:${r.diff===0?'green':'red'}">${r.diff!==null ? r.diff : '-'}</td>
                    <td><span class="status-badge status-${r.status}">${r.status}</span></td>
                    <td>${r.note}</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('totalItems').innerText = results.length;
            document.getElementById('matchedItems').innerText = matched;
            document.getElementById('matchRate').innerText = ((matched/results.length)*100).toFixed(1) + '%';
        }
    </script>
</body>
</html>
